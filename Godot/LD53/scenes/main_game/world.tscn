[gd_scene load_steps=21 format=2]

[ext_resource path="res://scenes/main_game/player.tscn" type="PackedScene" id=1]
[ext_resource path="res://textures/Lava_1/lava_1_metallic.png" type="Texture" id=2]
[ext_resource path="res://textures/Lava_1/lava_1_ao.png" type="Texture" id=3]
[ext_resource path="res://textures/Lava_1/lava_1_normal.png" type="Texture" id=4]
[ext_resource path="res://textures/Lava_1/lava_1_diffuseOriginal.png" type="Texture" id=5]
[ext_resource path="res://textures/Lava_1/lava_1_smoothness.png" type="Texture" id=6]
[ext_resource path="res://scenes/main_game/shop_island.tscn" type="PackedScene" id=7]
[ext_resource path="res://scenes/main_game/dest_island.tscn" type="PackedScene" id=8]
[ext_resource path="res://scenes/HUD/HUD.tscn" type="PackedScene" id=9]

[sub_resource type="ProceduralSky" id=12]
sky_top_color = Color( 1, 0, 0, 1 )
sky_horizon_color = Color( 1, 0.72549, 0, 1 )
ground_bottom_color = Color( 1, 0, 0, 1 )
ground_horizon_color = Color( 1, 0.72549, 0, 1 )
ground_curve = 1.74
ground_energy = 1.5
sun_color = Color( 1, 0.937255, 0, 1 )
sun_energy = 3.0

[sub_resource type="Environment" id=11]
background_mode = 2
background_sky = SubResource( 12 )
fog_enabled = true
fog_color = Color( 0.270588, 0.0117647, 0, 0.819608 )
fog_sun_color = Color( 1, 0.72549, 0, 1 )
fog_depth_begin = 100.0
fog_depth_end = 350.0
dof_blur_far_distance = 300.0
dof_blur_far_transition = 0.01
dof_blur_far_amount = 0.14
dof_blur_far_quality = 2
dof_blur_near_distance = 1.76
glow_enabled = true
glow_bicubic_upscale = true

[sub_resource type="SpatialMaterial" id=2]
flags_world_triplanar = true
albedo_texture = ExtResource( 5 )
metallic_texture = ExtResource( 2 )
roughness_texture = ExtResource( 6 )
normal_enabled = true
normal_scale = 0.0
normal_texture = ExtResource( 4 )
ao_enabled = true
ao_light_affect = 0.0
ao_texture = ExtResource( 3 )
ao_on_uv2 = false
ao_texture_channel = 0
uv1_scale = Vector3( 0.5, 1, 0.5 )
uv1_triplanar = true

[sub_resource type="CubeMesh" id=1]
material = SubResource( 2 )
size = Vector3( 10000, 50, 10000 )

[sub_resource type="ConcavePolygonShape" id=3]
data = PoolVector3Array( -500, 25, 500, 500, 25, 500, -500, -25, 500, 500, 25, 500, 500, -25, 500, -500, -25, 500, 500, 25, -500, -500, 25, -500, 500, -25, -500, -500, 25, -500, -500, -25, -500, 500, -25, -500, 500, 25, 500, 500, 25, -500, 500, -25, 500, 500, 25, -500, 500, -25, -500, 500, -25, 500, -500, 25, -500, -500, 25, 500, -500, -25, -500, -500, 25, 500, -500, -25, 500, -500, -25, -500, 500, 25, 500, -500, 25, 500, 500, 25, -500, -500, 25, 500, -500, 25, -500, 500, 25, -500, -500, -25, 500, 500, -25, 500, -500, -25, -500, 500, -25, 500, 500, -25, -500, -500, -25, -500 )

[sub_resource type="SphereShape" id=10]
radius = 20.0

[sub_resource type="Shader" id=5]
code = "/*
	炎シェーダー by あるる（きのもと 結衣）
	Fire Shader by Yui Kinomoto @arlez80

	MIT License
*/
shader_type spatial;
render_mode depth_draw_opaque, unshaded, shadows_disabled, cull_disabled;

uniform sampler2D noise_tex : hint_white;
uniform vec4 root_color : hint_color = vec4( 1.0, 0.75, 0.3, 1.0 );
uniform vec4 tip_color : hint_color = vec4( 1.0, 0.03, 0.001, 1.0 );

uniform float fire_alpha : hint_range( 0.0, 1.0 ) = 1.0;
uniform vec2 fire_speed = vec2( 0.0, 1.0 );
uniform float fire_aperture : hint_range( 0.0, 3.0 ) = 0.22;

/*
	noise_texを使わないパターン

float random( vec2 pos )
{ 
	return fract(sin(dot(pos, vec2(12.9898,78.233))) * 43758.5453);
}

float value_noise( vec2 pos )
{
	vec2 p = floor( pos );
	vec2 f = fract( pos );

	float v00 = random( p + vec2( 0.0, 0.0 ) );
	float v10 = random( p + vec2( 1.0, 0.0 ) );
	float v01 = random( p + vec2( 0.0, 1.0 ) );
	float v11 = random( p + vec2( 1.0, 1.0 ) );

	vec2 u = f * f * ( 3.0 - 2.0 * f );

	return mix( mix( v00, v10, u.x ), mix( v01, v11, u.x ), u.y );
}

float procedural_noise_tex( vec2 shifted_uv )
{
	return (
		value_noise( shifted_uv * 0.984864 ) * 20.0
	+	value_noise( shifted_uv * 2.543 ) * 10.0
	+	value_noise( shifted_uv * 9.543543 ) * 8.0
	+	value_noise( shifted_uv * 21.65436 ) * 5.0
	+	value_noise( shifted_uv * 42.0 ) * 2.0
	+	value_noise( shifted_uv * 87.135148 ) * 2.0
	+	value_noise( shifted_uv * 340.66534654 )
	) / 48.0;
}
*/

void fragment( )
{
	vec2 shifted_uv = UV + TIME * fire_speed;
	float fire_noise = texture( noise_tex, shifted_uv ).r;
	float noise = UV.y * ( ( ( UV.y + fire_aperture ) * fire_noise - fire_aperture ) * 75.0 );
	vec4 fire_color = mix( tip_color, root_color, noise * 0.05 );

	ALPHA = clamp( noise, 0.0, 1.0 ) * fire_alpha;
	ALBEDO = fire_color.rgb;
}"

[sub_resource type="OpenSimplexNoise" id=8]

[sub_resource type="NoiseTexture" id=9]
seamless = true
noise = SubResource( 8 )

[sub_resource type="ShaderMaterial" id=6]
shader = SubResource( 5 )
shader_param/root_color = Color( 4, 3, 1.2, 1 )
shader_param/tip_color = Color( 4, 0.12, 0, 1 )
shader_param/fire_alpha = 0.75
shader_param/fire_speed = Vector2( 0.25, 1 )
shader_param/fire_aperture = 0.22
shader_param/noise_tex = SubResource( 9 )

[sub_resource type="SphereMesh" id=7]
material = SubResource( 6 )
radius = 20.0
height = 7.0
radial_segments = 128
rings = 16
is_hemisphere = true

[node name="world" type="Spatial"]

[node name="WorldEnvironment" type="WorldEnvironment" parent="."]
environment = SubResource( 11 )

[node name="HUD" parent="." instance=ExtResource( 9 )]

[node name="directional_light" type="DirectionalLight" parent="."]
transform = Transform( 1, 0, 0, 0, -0.864643, 0.502386, 0, -0.502386, -0.864643, 0, 0, 0 )
light_energy = 1.5
light_specular = 0.05

[node name="player" parent="." instance=ExtResource( 1 )]
transform = Transform( 1, 0, 0, 0, 1, 0, 0, 0, 1, -295.612, -3.22454, 215.445 )
max_rpm = 1300.0

[node name="lava" type="MeshInstance" parent="."]
transform = Transform( 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, -29, 0 )
mesh = SubResource( 1 )

[node name="StaticBody" type="StaticBody" parent="lava"]
collision_mask = 2

[node name="CollisionShape" type="CollisionShape" parent="lava/StaticBody"]
transform = Transform( 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, -4.8, 0 )
shape = SubResource( 3 )

[node name="shop_island" parent="." instance=ExtResource( 7 )]

[node name="dest_island" parent="." instance=ExtResource( 8 )]
transform = Transform( -6.55671e-06, 0, 150, 0, 21.665, 0, -150, 0, -6.55671e-06, 616.45, 0, 29.8538 )

[node name="objective" type="Area" parent="."]
transform = Transform( 1, 0, 0, 0, 1, 0, 0, 0, 1, -1300, -3.24, 300 )
visible = false

[node name="CollisionShape" type="CollisionShape" parent="objective"]
shape = SubResource( 10 )
__meta__ = {
"_edit_lock_": true
}

[node name="MeshInstance" type="MeshInstance" parent="objective"]
mesh = SubResource( 7 )

[connection signal="objective_reached" from="player" to="HUD" method="_on_player_objective_reached"]
[connection signal="use_fuel" from="player" to="HUD" method="_on_player_use_fuel"]
[connection signal="body_entered" from="objective" to="player" method="_on_objective_body_entered"]
[connection signal="body_exited" from="objective" to="player" method="_on_objective_body_exited"]
